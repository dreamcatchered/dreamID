{% extends "base.html" %}

{% block content %}
<div class="login-wrapper">
    <div class="login-card">
        <div class="logo-badge"><i class="ph ph-user-plus"></i></div>
        <h1 style="font-size: 24px; margin-bottom: 8px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
        <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 24px;">–°–æ–∑–¥–∞–Ω–∏–µ dreamID</p>

        <!-- REGISTER FORM (USERNAME + PASSWORD + OPTIONAL PHONE) -->
        <form id="registerForm">
            <div class="input-stack">
                <input type="text" class="custom-input" id="username" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω" required autocomplete="username">
                <input type="password" class="custom-input" id="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" required minlength="6" autocomplete="new-password">
                <input type="password" class="custom-input" id="confirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required minlength="6" autocomplete="new-password">
                <input type="tel" class="custom-input" id="phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" autocomplete="tel">
            </div>
            <p class="hint-text" style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                üí° –ù–æ–º–µ—Ä –Ω—É–∂–µ–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram. –ú–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –ø–æ–∑–∂–µ.
            </p>
            
            <button type="submit" class="btn-primary" style="margin-top: 16px;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </form>

        <div id="alert" class="alert"></div>

        <div style="margin-top: 24px; font-size: 14px; color: var(--text-muted); padding-top: 16px; border-top: 1px solid var(--border);">
            <a href="{{ url_for('login') }}" style="color: var(--text-muted); text-decoration: none;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Animation
    gsap.from(".login-card", {
        duration: 0.6,
        y: 30,
        opacity: 0,
        ease: "power3.out"
    });

    // Restrict Phone Input (Only numbers and +)
    document.getElementById('phone').addEventListener('input', function() {
        // Allow digits and + at the beginning
        this.value = this.value.replace(/[^\d+]/g, '');
    });

    function showAlert(message, type) {
        const alert = document.getElementById('alert');
        alert.textContent = message;
        alert.className = 'alert alert-' + type;
        alert.style.display = 'block';
        
        if (type === 'success') {
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const phone = document.getElementById('phone').value.trim();
        
        if (!username || !password || !confirmPassword) {
            showAlert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        if (password.length < 6) {
            showAlert('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
            return;
        }

        if (password !== confirmPassword) {
            showAlert('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
            return;
        }
        
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
        
        try {
            const response = await fetch('/api/register/simple', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: username,
                    password: password,
                    phone: phone || null
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!', 'success');
                
                // Success Animation
                const tl = gsap.timeline();
                tl.to('.login-card', {
                    duration: 0.5,
                    opacity: 0,
                    y: 30,
                    scale: 0.95,
                    filter: "blur(10px)",
                    ease: 'power2.in',
                    onComplete: () => {
                        window.location.href = '/';
                    }
                });
            } else {
                let errorMsg = data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                if (errorMsg.includes('already exists')) errorMsg = '–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç';
                showAlert('‚ùå ' + errorMsg, 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (error) {
            showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });
</script>
{% endblock %}
